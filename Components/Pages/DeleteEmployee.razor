@page "/manager-panel/delete-employee"
@using _213FinalProject.Data
@using _213FinalProject.Models
@using Microsoft.EntityFrameworkCore
@inject _213FinalProjectContext context
@inject NavigationManager Navigation
@inject AuthService AuthService

<PageTitle>Delete Employee</PageTitle>

<div class="container">
    <h1>Delete Employee</h1>

    <NavLink class="btn btn-outline-primary" href="/manager-panel">
        Back to Manager Panel
    </NavLink>

    @if (!string.IsNullOrEmpty(Message))
    {
        <div class="alert @(IsError ? "alert-danger" : "alert-success")">
            @Message
        </div>
    }

  

    <!-- Employee List -->
    <h3>Current Employees</h3>

    @if (Employees == null)
    {
        <p><em>Loading employees...</em></p>
    }
    else if (!Employees.Any())
    {
        <p><em>No employees found.</em></p>
    }
    else
    {
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Name</th>
                    <th>Email</th>
                    <th>Phone</th>
                    <th>Type</th>
                    <th>Hire Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var employee in FilteredEmployees)
                {
                    <tr>
                        <td>@employee.UserID</td>
                        <td>@employee.FullName</td>
                        <td>@employee.Email</td>
                        <td>@employee.PhoneNumber</td>
                        <td>
                            @if (employee is Manager)
                            {
                                <span class="badge bg-primary">Manager</span>
                            }
                            else if (employee is Receptionist)
                            {
                                <span class="badge bg-info">Receptionist</span>
                            }
                            else if (employee is ServicePerforming)
                            {
                                <span class="badge bg-success">Service Provider</span>
                            }
                        </td>
                        <td>@employee.HireDate</td>
                        <td>
                            @if (employee.IsActive)
                            {
                                <span class="badge bg-success">Active</span>
                            }
                            else
                            {
                                <span class="badge bg-secondary">Inactive</span>
                            }
                        </td>
                        <td>
                            <button class="btn btn-sm btn-danger"
                                    @onclick="() => ShowDeleteConfirmation(employee)">
                                Delete
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }

    <!-- Delete Confirmation -->
    @if (ShowConfirmation && EmployeeToDelete != null)
    {
        <div class="modal-overlay">
            <div class="modal-content">
                <h3>Confirm Deletion</h3>
                <p>Are you sure you want to delete this employee?</p>
                <div class="employee-details">
                    <p><strong>Name:</strong> @EmployeeToDelete.FullName</p>
                    <p><strong>Email:</strong> @EmployeeToDelete.Email</p>
                    <p><strong>Type:</strong> @EmployeeToDelete.GetType().Name</p>
                </div>
                <p class="text-danger">
                    <strong>Warning:</strong> This action cannot be undone.
                    Any upcoming appointments with this employee will be affected.
                </p>
                <div class="modal-actions">
                    <button class="btn btn-danger" @onclick="ConfirmDelete">
                        Yes, Delete Employee
                    </button>
                    <button class="btn btn-secondary" @onclick="CancelDelete">
                        Cancel
                    </button>
                </div>
            </div>
        </div>
    }
</div>

<style>
   

    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 1000;
    }

    .modal-content {
        background: white;
        padding: 30px;
        border-radius: 8px;
        max-width: 500px;
        width: 90%;
    }

    .employee-details {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 5px;
        margin: 15px 0;
    }

    .modal-actions {
        display: flex;
        gap: 10px;
        justify-content: flex-end;
        margin-top: 20px;
    }

    .badge {
        padding: 5px 10px;
        border-radius: 4px;
        color: white;
    }

    .bg-primary {
        background-color: #007bff;
    }

    .bg-info {
        background-color: #17a2b8;
    }

    .bg-success {
        background-color: #28a745;
    }

    .bg-secondary {
        background-color: #6c757d;
    }
</style>

@code {

    private bool _checkedAuth;
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _checkedAuth)
            return;

        _checkedAuth = true;

        if (!await AuthService.IsLoggedInAsync())
        {
            Navigation.NavigateTo("/LoginUser", forceLoad: true);
        }
        StateHasChanged();
    }


    private List<Employee>? Employees { get; set; }
    private Employee? EmployeeToDelete { get; set; }
    private bool ShowConfirmation { get; set; } = false;
    private string SearchTerm { get; set; } = string.Empty;
    private string Message { get; set; } = string.Empty;
    private bool IsError { get; set; } = false;

    private IEnumerable<Employee> FilteredEmployees
    {
        get
        {
            if (Employees == null) return Enumerable.Empty<Employee>();

            if (string.IsNullOrWhiteSpace(SearchTerm))
                return Employees;

            return Employees.Where(e =>
                e.FullName.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase) ||
                e.Email.Contains(SearchTerm, StringComparison.OrdinalIgnoreCase)
            );
        }
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadEmployees();
    }

    private async Task LoadEmployees()
    {
        Employees = await context.Employee
            .OrderBy(e => e.LastName)
            .ThenBy(e => e.FirstName)
            .ToListAsync();
    }

    private void ShowDeleteConfirmation(Employee employee)
    {
        EmployeeToDelete = employee;
        ShowConfirmation = true;
    }

    private void CancelDelete()
    {
        EmployeeToDelete = null;
        ShowConfirmation = false;
    }

    private async Task ConfirmDelete()
    {
        if (EmployeeToDelete == null) return;

        try
        {
            // Check if employee has upcoming appointments
            var hasAppointments = await context.Appointment
                .AnyAsync(a => a.EmployeeID == EmployeeToDelete.UserID &&
                               a.ScheduledDate >= DateOnly.FromDateTime(DateTime.Now));

            if (hasAppointments)
            {
                Message = "This employee has upcoming appointments.";
                IsError = true;
                ShowConfirmation = false;
                return;
            }

            // Delete the employee
            context.Employee.Remove(EmployeeToDelete);
            await context.SaveChangesAsync();

            Message = $"Employee {EmployeeToDelete.FullName} has been successfully deleted.";
            IsError = false;

            // Reload employees list
            await LoadEmployees();

            // Reset
            EmployeeToDelete = null;
            ShowConfirmation = false;
        }
        catch (Exception ex)
        {
            Message = $"Error deleting employee: {ex.Message}";
            IsError = true;
            ShowConfirmation = false;
        }
    }
}