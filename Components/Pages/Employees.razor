@page "/employees"
@attribute [StreamRendering]
@using Data
@using _213FinalProject.Models

<PageTitle>Employees</PageTitle>

<h1>Employees</h1>

<p>List of employees with photo placeholder and contact / role information.</p>

@if (employees == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="row row-cols-1 row-cols-md-2 row-cols-lg-3 g-3">
        @foreach (var employee in employees)
        {
            var slug = SlugHelper.ToSlug(employee.FullName);
            var href = $"/employees/{slug}?returnUrl=/employees";
            <div class="col">
                <a class="text-decoration-none text-body" href="@href">
                    <div class="card h-100">

                        <div class="row g-0 align-items-center p-3">
                            <div class="col">
                                <div class="card-body p-0 ps-3">
                                    <h5 class="card-title mb-1">@employee.FullName</h5>
                                    <p class="mb-1 text-muted">@GetRole(employee)</p>
                                    <p class="mb-1"><a href="mailto:@employee.Email">@employee.Email</a></p>
                                    @if (!string.IsNullOrWhiteSpace(employee.PhoneNumber))
                                    {
                                        <p class="mb-1"><a href="tel:@employee.PhoneNumber">@employee.PhoneNumber</a></p>
                                    }


                                    @* <p class="mb-1"><small class="text-muted">Hired: FormatTimeSince(@employee.HireDate.ToString("d")</small></p> *@
                                    <p class="mb-1"><small class="text-muted">Hired: @FormatTimeSince(@employee.HireDate)</small></p>

                                    @if (!string.IsNullOrWhiteSpace(employee.Bio))
                                    {
                                        <p class="mb-0">@employee.Bio</p>
                                    }
                                </div>
                            </div>


                            <div class="col-auto">
                                <img src="@employee.PhotoURL" class="profile-image rounded" alt="@employee.FullName" style="width:120px;height:180px;object-fit:cover;" />
                            </div>
                        </div>

                    </div>
                </a>
            </div>
        }
    </div>
}

@code {
    private IReadOnlyList<Employee>? employees;

    protected override async Task OnInitializedAsync()
    {
        // small delay to demonstrate loading state when StreamRendering is enabled
        await Task.Delay(200);
        employees = SeedData.Employees;
    }

    private static string GetRole(Employee e)
    {
        return e switch
        {
            Manager => "Manager",
            Receptionist => "Receptionist",
            ServicePerforming => "Service Performer",
            _ => "Employee"
        };
    }

    public static string FormatTimeSince(DateOnly date)
    {
        var dateTime = date.ToDateTime(TimeOnly.MinValue);
        var now = DateTime.Now;
        var span = now - dateTime;

        if (span.TotalMinutes < 1)
            return "just now";

        if (span.TotalHours < 1)
            return $"{(int)span.TotalMinutes} min ago";

        if (span.TotalDays < 1)
            return $"{(int)span.TotalHours} hr ago";

        if (span.TotalDays < 7)
            return $"{(int)span.TotalDays} days ago";

        if (span.TotalDays < 30)
            return $"{(int)(span.TotalDays / 7)} weeks ago";

        if (span.TotalDays < 365)
            return dateTime.ToString("MMM yyyy"); // e.g. Mar 2024

        return dateTime.ToString("yyyy");
    }

}
