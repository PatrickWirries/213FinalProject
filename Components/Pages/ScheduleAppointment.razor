@page "/schedule-appointment"
@rendermode InteractiveServer
@using Data
@using _213FinalProject.Models
@inject _213FinalProjectContext context
@inject NavigationManager Navigation
@inject AuthService AuthService

<PageTitle>Schedule Appointment</PageTitle>

<h1>Schedule Appointment</h1>

@* --=-- Service Selection --=-- *@
<div class="mb-3">
    <label class="form-label">Service</label>
    <div>
        @foreach (var s in filteredServices)
        {
            bool disabled = selectedEmployeeId.HasValue &&
            !employeeServiceMap[selectedEmployeeId.Value].Contains(s.ServiceID);

            <button class="btn @(selectedServiceId == s.ServiceID ? "btn-success" : "btn-outline-primary") me-2 mb-2"
                    disabled="@disabled"
                    @onclick="() => ToggleService(s.ServiceID)">
                @s.Name (@s.DurationMinutes min) - @s.BasePrice.ToString("C")
            </button>
        }
    </div>
</div>

@* --=-- Employee Selection --=-- *@
<div class="mb-3">
    <label class="form-label">Employee</label>
    <div>
        @foreach (var e in filteredEmployees)
        {
            bool disabled = selectedServiceId.HasValue &&
            !serviceEmployeeMap[selectedServiceId.Value].Contains(e.UserID);

            <button class="btn @(selectedEmployeeId == e.UserID ? "btn-success" : "btn-outline-primary") me-2 mb-2"
                    disabled="@disabled"
                    @onclick="() => ToggleEmployee(e.UserID)">
                @e.FullName
            </button>
        }
    </div>
</div>

@* --=-- Date Selection --=-- *@
<div class="mb-3 date-selector">
    <label class="form-label">Date</label>
    <InputDate @bind-Value="selectedDate"
               class="form-control"
               Min="@DateTime.Today" />
</div>

@* --=-- Time Selection --=-- *@
<div class="mb-3">
    <label class="form-label">Timeslots</label>

    @if (selectedDate == null || selectedServiceId == null || selectedEmployeeId == null)
    {
        <div class="text-muted">Select date, service, and employee to view availability.</div>
    }
    else
    {
        <div>
            @foreach (var time in GetAvailableTimeSlots())
            {
                <button class="btn @(model.ScheduledTime == time ? "btn-success" : "btn-outline-primary") me-2 mb-2"
                        @onclick="() => SelectTime(time)">
                    @time.ToString("hh:mm tt")
                </button>
            }
        </div>
    }
</div>

@* --=-- Price Display --=-- *@
<div class="mb-3 price-display">
    <label class="form-label">Price</label>
    <InputText class="form-control" @bind-Value="displayPrice" readonly />
</div>

<button class="btn btn-primary btn-submit" @onclick="SubmitAppointment">
    Schedule
</button>

@if (!string.IsNullOrEmpty(successMessage))
{
    <div class="alert alert-success mt-3">@successMessage</div>
}


@code {

    private bool _checkedAuth;
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (!firstRender || _checkedAuth)
            return;

        _checkedAuth = true;

        if (!await AuthService.IsLoggedInAsync())
        {
            Navigation.NavigateTo("/LoginUser", forceLoad: true);
        }
        StateHasChanged();
    }


    private static readonly TimeOnly BusinessOpen = new(9, 0);
    private static readonly TimeOnly BusinessClose = new(17, 0);
    private const int SlotMinutes = 30;

    private Appointment model = new();
    private string? successMessage;
    private string displayPrice = "N/A";

    private List<Customer> customers = new();
    private List<Service> services = new();
    private List<ServicePerforming> performingEmployees = new();

    private List<Service> filteredServices => services;
    private List<ServicePerforming> filteredEmployees => performingEmployees;

    private int? selectedServiceId;
    private int? selectedEmployeeId;
    private DateOnly? selectedDate = DateOnly.FromDateTime(DateTime.Today);

    private Dictionary<int, List<int>> serviceEmployeeMap = new();
    private Dictionary<int, List<int>> employeeServiceMap = new();


    protected override void OnInitialized()

    {
        customers = context.Customer.ToList();
        services = context.Service.ToList();
        performingEmployees = context.Employee.OfType<ServicePerforming>().ToList();

        foreach (var sp in context.ServicePerformingEmployeeService)
        {
            serviceEmployeeMap
                .TryAdd(sp.ServiceID, new List<int>());
            serviceEmployeeMap[sp.ServiceID].Add(sp.EmployeeID);

            employeeServiceMap
                .TryAdd(sp.EmployeeID, new List<int>());
            employeeServiceMap[sp.EmployeeID].Add(sp.ServiceID);
        }
    }

    private void ToggleService(int serviceId)
    {
        if (selectedServiceId == serviceId)
        {
            selectedServiceId = null;
            model.ServiceID = 0;
            model.Price = 0;
            model.Duration = 0;
            displayPrice = "N/A";
        }
        else
        {
            selectedServiceId = serviceId;
            model.ServiceID = serviceId;

            var s = services.First(x => x.ServiceID == serviceId);
            model.Price = s.BasePrice;
            model.Duration = s.DurationMinutes;
            displayPrice = s.BasePrice.ToString("C");

            if (selectedEmployeeId.HasValue &&
                !serviceEmployeeMap[serviceId].Contains(selectedEmployeeId.Value))
            {
                selectedEmployeeId = null;
                model.EmployeeID = 0;
            }
        }
    }

    private void ToggleEmployee(int employeeId)
    {
        if (selectedEmployeeId == employeeId)
        {
            selectedEmployeeId = null;
            model.EmployeeID = 0;
        }
        else
        {
            selectedEmployeeId = employeeId;
            model.EmployeeID = employeeId;

            if (selectedServiceId.HasValue &&
                !employeeServiceMap[employeeId].Contains(selectedServiceId.Value))
            {
                selectedServiceId = null;
                model.ServiceID = 0;
                displayPrice = "N/A";
            }
        }
    }

    private List<TimeOnly> GetAvailableTimeSlots()
    {
        if (!selectedDate.HasValue || !selectedEmployeeId.HasValue || !selectedServiceId.HasValue)
            return new();

        var service = services.First(s => s.ServiceID == selectedServiceId.Value);
        int duration = service.DurationMinutes;

        var reserved = context.Appointment
            .Where(a =>
                a.EmployeeID == selectedEmployeeId.Value &&
                a.ScheduledDate == selectedDate.Value)
            .ToList();

        var slots = new List<TimeOnly>();
        var current = BusinessOpen;

        while (current.AddMinutes(duration) <= BusinessClose)
        {
            var slotEnd = current.AddMinutes(duration);

            bool overlaps = reserved.Any(a =>
            {
                var existingStart = a.ScheduledTime;
                var existingEnd = a.ScheduledTime.AddMinutes(a.Duration);
                return current < existingEnd && slotEnd > existingStart;
            });

            if (!overlaps)
                slots.Add(current);

            current = current.AddMinutes(SlotMinutes);
        }

        return slots;
    }

    private void SelectTime(TimeOnly time)
    {
        model.ScheduledTime = time;
        model.ScheduledDate = selectedDate!.Value;
    }

    private void SubmitAppointment()
    {
        if (model.ServiceID == 0 ||
            model.EmployeeID == 0 ||
            model.ScheduledTime == default)
        {
            successMessage = "Please complete all selections.";
            return;
        }

        context.Appointment.Add(model);
        context.SaveChanges();

        Navigation.NavigateTo("/UserAppointments");

        successMessage = "Appointment successfully scheduled.";

    }
}
