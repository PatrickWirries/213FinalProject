@page "/employees/{slug}"
@using Data
@using _213FinalProject.Models

<PageTitle>Employee Details</PageTitle>

@if (employee == null)
{
    <p><em>Loading...</em></p>
}
else
{
    <div class="card">
        <div class="card-body d-flex gap-4">
            <img src="https://via.placeholder.com/200" alt="@employee.FullName" style="width:200px;height:200px;object-fit:cover;" class="rounded" />
            <div>
                <h2>@employee.FullName</h2>
                <p class="text-muted">@GetRole(employee)</p>
                <p><a href="mailto:@employee.Email">@employee.Email</a> | @if (!string.IsNullOrWhiteSpace(employee.PhoneNumber)) { <a href="tel:@employee.PhoneNumber">@employee.PhoneNumber</a> }</p>
                <p><small class="text-muted">Hired: @employee.HireDate.ToString("d")</small></p>
                @if (!string.IsNullOrWhiteSpace(employee.Bio))
                {
                    <p>@employee.Bio</p>
                }

                <h4>Services</h4>
                @if (employeeServices == null)
                {
                    <p><em>Loading services...</em></p>
                }
                else if (!employeeServices.Any())
                {
                    <p><em>No services assigned.</em></p>
                }
                else
                {
                    <ul>
                        @foreach (var s in employeeServices)
                        {
                            <li>@s.Name (@s.Category) - @s.DurationMinutes min - @s.BasePrice.ToString("C")</li>
                        }
                    </ul>
                }

            </div>
        </div>
    </div>
}

@code {
    [Parameter]
    public string? slug { get; set; }

    private Employee? employee;
    private List<Service>? employeeServices;

    protected override async Task OnInitializedAsync()
    {
        await Task.Delay(100);

        if (!string.IsNullOrWhiteSpace(slug))
        {
            employee = SeedData.Employees.FirstOrDefault(e => SlugHelper.ToSlug(e.FullName) == slug);
            if (employee != null)
            {
                var serviceIds = SeedData.ServicePerformingEmployeeServices
                    .Where(x => x.EmployeeID == employee.EmployeeID)
                    .Select(x => x.ServiceID)
                    .ToHashSet();

                employeeServices = SeedData.Services
                    .Where(s => serviceIds.Contains(s.ServiceID))
                    .ToList();
            }
        }
    }

    private static string GetRole(Employee e) => e switch
    {
        Manager => "Manager",
        Receptionist => "Receptionist",
        ServicePerforming => "Service Performer",
        _ => "Employee"
    };
}
